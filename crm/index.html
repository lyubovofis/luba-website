<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - Денежный Водопад</title>
    
    <!-- TikTok Pixel -->
    <script>
    !function (w, d, t) {
        w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};
        ttq.load('D3460MRC77U1O98E3OGG');
        ttq.page();
    }(window, document, 'ttq');
    </script>
    
    <!-- Facebook Pixel -->
    <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '2067039850492790');
    fbq('track', 'PageView');
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* Header */
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }
        
        /* Filters */
        .filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }        
        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .stat-change {
            font-size: 0.8rem;
            color: #10b981;
            margin-top: 5px;
        }
        
        /* Analytics Section - только видео */
        .analytics-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }        
        .analytics-card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .top-sources {
            list-style: none;
        }
        
        .top-sources li {
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .source-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }
        
        .top-videos {
            list-style: none;
        }
        
        .top-videos li {
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 8px;
        }
        
        .video-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .video-stats {
            font-size: 0.85rem;
            color: #666;
        }        
        /* Pipeline */
        .pipeline {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .pipeline-stages {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stage {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            min-height: 400px;
        }
        
        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .lead-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: move;
            border: 1px solid #e9ecef;
        }
        
        .lead-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }        
        .lead-amount {
            font-weight: bold;
            color: #764ba2;
        }
        
        .lead-tags {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        
        .tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .tag-hot { background: #fee2e2; color: #dc2626; }
        .tag-tiktok { background: #000; color: white; }
        .tag-instagram { background: #E4405F; color: white; }
        .tag-facebook { background: #1877f2; color: white; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #764ba2;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }        
        
        /* Mobile Responsive Improvements */
        @media (max-width: 1024px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .filters {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filter-select, #searchInput {
                width: 100% !important;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .pipeline-stages {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stage {
                min-height: 200px;
            }
            
            .lead-card {
                padding: 10px;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .analytics-section {
                padding: 15px;
            }
            
            .top-videos li {
                padding: 8px;
            }
            
            .video-title {
                font-size: 0.9rem;
            }
            
            .video-stats {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 15px;
                border-radius: 10px;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .lead-tags {
                flex-wrap: wrap;
            }
            
            .tag {
                font-size: 0.7rem;
                padding: 2px 6px;
            }
            
            .btn {
                font-size: 0.85rem;
            }
        }
    </style>
    <script src="export-lookalike.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">💰 CRM Денежный Водопад</div>
            <div class="header-controls">
                <button class="btn btn-success" onclick="exportData()">📊 Экспорт</button>
                <button class="btn btn-primary" onclick="showAddModal()">+ Новый лид</button>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>Период:</label>
                <select class="filter-select" id="periodFilter" onchange="applyFilters()">
                    <option value="all">Все время</option>
                    <option value="today">Сегодня</option>
                    <option value="yesterday">Вчера</option>
                    <option value="7">7 дней</option>
                    <option value="14">14 дней</option>
                    <option value="30" selected>30 дней</option>
                    <option value="90">3 месяца</option>
                    <option value="180">6 месяцев</option>
                    <option value="365">Год</option>
                </select>
            </div>            
            <div class="filter-group">
                <label>Источник:</label>
                <select class="filter-select" id="sourceFilter" onchange="applyFilters()">
                    <option value="all">Все</option>
                    <option value="tiktok">TikTok</option>
                    <option value="instagram">Instagram</option>
                    <option value="facebook">Facebook</option>
                    <option value="direct">Прямой</option>
                </select>
            </div>
            
            <div class="filter-group">
                <input type="text" class="form-input" id="searchInput" placeholder="Поиск по имени/телефону" style="width: 200px;" oninput="searchLeads()">
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Всего лидов</div>
                <div class="stat-value" id="totalLeads">0</div>
                <div class="stat-change" id="leadsChange">+0% за период</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Консультации</div>
                <div class="stat-value" id="totalConsultations">0</div>
                <div class="stat-change" id="consultChange">конверсия 0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Продажи</div>
                <div class="stat-value" id="totalSales">0</div>
                <div class="stat-change" id="salesChange">конверсия 0%</div>
            </div>            <div class="stat-card">
                <div class="stat-label">Выручка</div>
                <div class="stat-value" id="totalRevenue">€0</div>
                <div class="stat-change" id="avgCheck">сред. чек €0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ROI</div>
                <div class="stat-value" id="roi">0%</div>
                <div class="stat-change">CAC: €0</div>
            </div>
        </div>
        
        <!-- Analytics Section -->
        <div class="analytics-section">
            <div class="analytics-card">
                <h3>📊 Топ источники (30 дней)</h3>
                <ul class="top-sources" id="topSources">
                    <!-- Динамически заполняется -->
                </ul>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('pipeline')">Воронка продаж</button>
                <button class="tab-button" onclick="showTab('quiz')">📊 Квиз: Денежные блоки</button>
            </div>
            
            <!-- Pipeline Tab -->
            <div id="pipeline-tab" class="tab-content active">
                <!-- Pipeline -->
                <div class="pipeline">
                    <h2>Воронка продаж</h2>
            <div class="pipeline-stages">
                <div class="stage" data-stage="contacted">
                    <div class="stage-header">
                        <span id="stage-title-contacted">💬 Написал (0)</span>
                        <span id="count-contacted">€0</span>
                    </div>
                    <div id="leads-contacted"></div>
                </div>                
                <div class="stage" data-stage="consultation">
                    <div class="stage-header">
                        <span id="stage-title-consultation">📅 Консультация (0)</span>
                        <span id="count-consultation">€0</span>
                    </div>
                    <div id="leads-consultation"></div>
                </div>
                
                <div class="stage" data-stage="paid">
                    <div class="stage-header">
                        <span id="stage-title-paid">✅ Оплата (0)</span>
                        <span id="count-paid">€0</span>
                    </div>
                    <div id="leads-paid"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Lead Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h2>Новый лид</h2>
            <form id="leadForm">
                <div class="form-group">
                    <label class="form-label">Имя*</label>
                    <input type="text" class="form-input" id="leadName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email*</label>
                    <input type="email" class="form-input" id="leadEmail" placeholder="email@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">WhatsApp*</label>
                    <input type="tel" class="form-input" id="leadPhone" placeholder="+34654420334" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Возраст</label>
                    <input type="number" class="form-input" id="leadAge" placeholder="35" min="18" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Источник</label>
                    <select class="form-input" id="leadSource">
                        <option value="tiktok">TikTok</option>
                        <option value="instagram">Instagram</option>
                        <option value="facebook">Facebook</option>
                        <option value="direct">Прямой</option>
                    </select>
                </div>                <div class="form-group">
                    <label class="form-label">UTM метки (скопируйте из сообщения клиента)</label>
                    <input type="text" class="form-input" id="leadUTM" placeholder="например: video_dengi_orgazm">
                    <small style="color: #666;">Спросите клиента: "С какого видео вы пришли?" или "Что вас заинтересовало?"</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Сумма (если оплачено)</label>
                    <input type="number" class="form-input" id="leadAmount" placeholder="2000">
                </div>
                <div class="form-group">
                    <label class="form-label">Заметка</label>
                    <textarea class="form-input" id="leadNote" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Сохранить</button>
                    <button type="button" class="btn" onclick="closeModal()" style="flex: 1;">Отмена</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
    // ============================================
    // PASSWORD PROTECTION
    // ============================================
    const CORRECT_PASSWORD = 'Luba1488@';
    const AUTH_KEY = 'crm_authenticated';
    const AUTH_EXPIRY = 14 * 24 * 60 * 60 * 1000; // 14 days
    
    // Check authentication
    function checkAuth() {
        const authData = localStorage.getItem(AUTH_KEY);
        if (!authData) return false;
        
        const { timestamp } = JSON.parse(authData);
        const now = Date.now();
        
        if (now - timestamp > AUTH_EXPIRY) {
            localStorage.removeItem(AUTH_KEY);
            return false;
        }
        return true;
    }
    
    // Prompt for password if not authenticated
    if (!checkAuth()) {
        const password = prompt('Введите пароль для доступа к CRM:');
        if (password !== CORRECT_PASSWORD) {
            alert('Неверный пароль! Доступ запрещен.');
            document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif;"><h1>Доступ запрещен</h1></div>';
        } else {
            localStorage.setItem(AUTH_KEY, JSON.stringify({ timestamp: Date.now() }));
        }
    }
    
    // ============================================
    // CRM LOGIC
    // ============================================
    let leads = JSON.parse(localStorage.getItem('crmLeads')) || [];
    let filteredLeads = [...leads];
    
    // Tracking functions
    function trackWhatsAppContact(lead) {
        const eventData = {
            content_name: 'WhatsApp Contact',
            value: 0,
            currency: 'EUR',
            source: lead.source,
            utm_campaign: lead.utm || 'direct'
        };
        
        if (typeof ttq !== 'undefined') {
            ttq.track('Lead', eventData);
        }
        
        if (typeof fbq !== 'undefined') {
            fbq('track', 'Lead', eventData);
        }
        
        if (typeof gtag !== 'undefined') {
            gtag('event', 'generate_lead', {
                currency: 'EUR',
                value: 0,
                lead_source: lead.source
            });
        }
        
        console.log('✅ Tracked: Lead', eventData);
    }    
    function trackConsultation(lead) {
        const eventData = {
            content_name: 'Free Consultation',
            value: 100,
            currency: 'EUR',
            predicted_ltv: 2000
        };
        
        if (typeof ttq !== 'undefined') {
            ttq.track('InitiateCheckout', eventData);
        }
        
        if (typeof fbq !== 'undefined') {
            fbq('track', 'Schedule', eventData);
        }
        
        if (typeof gtag !== 'undefined') {
            gtag('event', 'begin_checkout', {
                currency: 'EUR',
                value: 100,
                items: [{
                    item_name: 'Consultation',
                    price: 100
                }]
            });
        }
        
        console.log('✅ Tracked: Consultation', eventData);
    }
    
    function trackPurchase(lead, amount = 2000) {
        const eventData = {
            content_name: 'Transformation Program',
            value: amount,
            currency: 'EUR',
            utm_campaign: lead.utm || 'direct'
        };
        
        // Добавляем client_id для связи с исходной сессией
        const clientId = lead.phone ? lead.phone.replace(/\D/g, '') : lead.id;
        
        if (typeof ttq !== 'undefined') {
            ttq.track('PlaceAnOrder', eventData);
        }
        
        if (typeof fbq !== 'undefined') {
            fbq('track', 'Purchase', {
                ...eventData,
                external_id: clientId // Связываем по ID
            });
        }
        
        if (typeof gtag !== 'undefined') {
            gtag('event', 'purchase', {
                transaction_id: lead.id,
                value: amount,
                currency: 'EUR',
                user_id: clientId, // Связываем по ID
                items: [{
                    item_name: 'Transformation Program',
                    price: amount,
                    quantity: 1
                }]
            });
        }
        
        console.log('✅ Tracked: Purchase', eventData);
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        applyFilters();
        updateAnalytics();
        
        // Автообновление лидов с webhook сервера
        async function fetchNewLeads() {
            try {
                const response = await fetch('https://whatsapp-crm-webhook.onrender.com/api/leads');
                if (response.ok) {
                    const apiLeads = await response.json();
                    
                    apiLeads.forEach(apiLead => {
                        const exists = leads.find(l => l.phone === apiLead.phone);
                        if (!exists) {
                            leads.push(apiLead);
                            trackWhatsAppContact(apiLead);
                        }
                    });
                    
                    if (apiLeads.length > 0) {
                        saveLeads();
                        applyFilters();
                        updateAnalytics();
                    }
                }
            } catch (error) {
                console.log('Webhook сервер недоступен');
            }
        }
        
        // Проверяем каждые 30 секунд
        setInterval(fetchNewLeads, 30000);
        fetchNewLeads(); // Первая проверка сразу
    });    
    // Save leads
    function saveLeads() {
        localStorage.setItem('crmLeads', JSON.stringify(leads));
    }
    
    // Apply filters
    function applyFilters() {
        const period = document.getElementById('periodFilter').value;
        const source = document.getElementById('sourceFilter').value;
        
        filteredLeads = leads.filter(lead => {
            // Filter by period
            if (period !== 'all') {
                const leadDate = new Date(lead.date);
                const now = new Date();
                const diffDays = Math.floor((now - leadDate) / (1000 * 60 * 60 * 24));
                
                if (period === 'today' && diffDays !== 0) return false;
                if (period === 'yesterday' && diffDays !== 1) return false;
                if (period !== 'today' && period !== 'yesterday' && diffDays > parseInt(period)) return false;
            }
            
            // Filter by source
            if (source !== 'all' && lead.source !== source) return false;
            
            return true;
        });
        
        renderLeads();
        updateStats();
    }
    
    // Search leads
    function searchLeads() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        if (!search) {
            applyFilters();
            return;
        }
        
        filteredLeads = filteredLeads.filter(lead => 
            lead.name.toLowerCase().includes(search) || 
            lead.phone.includes(search)
        );
        
        renderLeads();
    }    
    // Render leads
    function renderLeads() {
        const containers = {
            contacted: document.getElementById('leads-contacted'),
            consultation: document.getElementById('leads-consultation'),
            paid: document.getElementById('leads-paid')
        };
        
        // Clear containers
        Object.values(containers).forEach(c => c.innerHTML = '');
        
        // Count leads by stage
        const counts = {
            contacted: filteredLeads.filter(l => l.stage === 'contacted').length,
            consultation: filteredLeads.filter(l => l.stage === 'consultation').length,
            paid: filteredLeads.filter(l => l.stage === 'paid').length
        };
        
        // Update stage titles with counts
        document.getElementById('stage-title-contacted').textContent = `💬 Написал (${counts.contacted})`;
        document.getElementById('stage-title-consultation').textContent = `📅 Консультация (${counts.consultation})`;
        document.getElementById('stage-title-paid').textContent = `✅ Оплата (${counts.paid})`;
        
        // Render filtered leads (limit display to 10 per column for performance)
        const displayLeads = {
            contacted: filteredLeads.filter(l => l.stage === 'contacted').slice(0, 10),
            consultation: filteredLeads.filter(l => l.stage === 'consultation').slice(0, 10),
            paid: filteredLeads.filter(l => l.stage === 'paid').slice(0, 10)
        };
        
        Object.entries(displayLeads).forEach(([stage, stageLeads]) => {
            stageLeads.forEach(lead => {
                const card = createLeadCard(lead);
                containers[stage].appendChild(card);
            });
        });
        
        // Update amounts
        const amounts = {
            contacted: 0,
            consultation: counts.consultation * 100,
            paid: filteredLeads.filter(l => l.stage === 'paid')
                               .reduce((sum, l) => sum + (l.amount || 0), 0)
        };
        
        document.getElementById('count-contacted').textContent = `€${amounts.contacted}`;
        document.getElementById('count-consultation').textContent = `€${amounts.consultation}`;
        document.getElementById('count-paid').textContent = `€${amounts.paid.toLocaleString()}`;
    }    
    // Create lead card
    function createLeadCard(lead) {
        const card = document.createElement('div');
        card.className = 'lead-card';
        card.draggable = true;
        card.dataset.leadId = lead.id;
        
        const amount = lead.amount ? `€${lead.amount}` : '';
        const date = new Date(lead.date).toLocaleDateString();
        
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div class="lead-name">${lead.name}</div>
                <div class="lead-amount">${amount}</div>
            </div>
            <div style="font-size: 0.85rem; color: #666;">
                ${lead.phone}<br>
                ${date}
                ${lead.note ? `<br><em>${lead.note}</em>` : ''}
            </div>
            <div class="lead-tags">
                <span class="tag tag-${lead.source}">${lead.source}</span>
                ${lead.hot ? '<span class="tag tag-hot">🔥 HOT</span>' : ''}
                ${lead.utm ? `<span class="tag" style="background: #e9ecef;">${lead.utm}</span>` : ''}
            </div>
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button class="btn" style="padding: 6px 12px; font-size: 0.85rem; background: #25d366; color: white;" 
                        onclick="openWhatsApp('${lead.phone}')">WhatsApp</button>
                <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem;" 
                        onclick="moveToNext(${lead.id})">Далее →</button>
                <button class="btn" style="padding: 6px 12px; font-size: 0.85rem;" 
                        onclick="editLead(${lead.id})">✏️</button>
            </div>
        `;
        
        // Drag handlers
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        
        return card;
    }    
    // Update stats
    function updateStats() {
        const stats = {
            total: filteredLeads.length,
            consultations: filteredLeads.filter(l => l.stage === 'consultation' || l.stage === 'paid').length,
            sales: filteredLeads.filter(l => l.stage === 'paid').length,
            revenue: filteredLeads.filter(l => l.stage === 'paid')
                                  .reduce((sum, l) => sum + (l.amount || 0), 0)
        };
        
        const conversionToConsult = stats.total > 0 ? 
            Math.round((stats.consultations / stats.total) * 100) : 0;
        const conversionToSale = stats.consultations > 0 ? 
            Math.round((stats.sales / stats.consultations) * 100) : 0;
        const avgCheck = stats.sales > 0 ? 
            Math.round(stats.revenue / stats.sales) : 0;
        
        document.getElementById('totalLeads').textContent = stats.total;
        document.getElementById('totalConsultations').textContent = stats.consultations;
        document.getElementById('totalSales').textContent = stats.sales;
        document.getElementById('totalRevenue').textContent = `€${stats.revenue.toLocaleString()}`;
        
        document.getElementById('consultChange').textContent = `конверсия ${conversionToConsult}%`;
        document.getElementById('salesChange').textContent = `конверсия ${conversionToSale}%`;
        document.getElementById('avgCheck').textContent = `сред. чек €${avgCheck.toLocaleString()}`;
        
        // Calculate ROI (simplified)
        const adSpend = stats.total * 10; // Assuming €10 per lead
        const roi = adSpend > 0 ? Math.round((stats.revenue / adSpend - 1) * 100) : 0;
        document.getElementById('roi').textContent = `${roi}%`;
    }
    
    // Update analytics
    function updateAnalytics() {
        // Top sources
        const sourceStats = {};
        filteredLeads.forEach(lead => {
            if (!sourceStats[lead.source]) {
                sourceStats[lead.source] = { leads: 0, revenue: 0 };
            }
            sourceStats[lead.source].leads++;
            if (lead.stage === 'paid') {
                sourceStats[lead.source].revenue += lead.amount || 0;
            }
        });
        
        const topSources = Object.entries(sourceStats)
            .sort((a, b) => b[1].revenue - a[1].revenue)
            .slice(0, 3);
        
        const sourcesHtml = topSources.map(([source, stats]) => `
            <li>
                <span><strong>${source}</strong></span>
                <div class="source-stats">
                    <span>${stats.leads} лидов</span>
                    <span>€${stats.revenue.toLocaleString()}</span>
                    <span>ROI ${stats.revenue > 0 ? Math.round((stats.revenue / (stats.leads * 10) - 1) * 100) : 0}%</span>
                </div>
            </li>
        `).join('');
        
        document.getElementById('topSources').innerHTML = sourcesHtml || '<li>Нет данных</li>';
        
        // Top videos (static for demo)
        const topVideosData = [
            { title: '84% женщин застряли на €1500', views: '245K', leads: 18, ctr: 7.3 },
            { title: 'Деньги как оргазм', views: '189K', leads: 15, ctr: 7.9 },
            { title: 'История Марины: €1800 → €5400', views: '156K', leads: 12, ctr: 7.6 }
        ];
        
        const videosHtml = topVideosData.map(video => `
            <li>
                <div class="video-title">${video.title}</div>
                <div class="video-stats">${video.views} просмотров • ${video.leads} лидов • CTR ${video.ctr}%</div>
            </li>
        `).join('');
        
        document.getElementById('topVideos').innerHTML = videosHtml;
    }    
    // Move to next stage
    function moveToNext(leadId) {
        const lead = leads.find(l => l.id === leadId);
        if (!lead) return;
        
        if (lead.stage === 'contacted') {
            lead.stage = 'consultation';
            trackConsultation(lead);
        } else if (lead.stage === 'consultation') {
            const amount = prompt('Сумма оплаты (EUR):', '2000');
            if (amount) {
                lead.amount = parseInt(amount) || 2000;
                lead.stage = 'paid';
                trackPurchase(lead, lead.amount);
            }
        }
        
        saveLeads();
        applyFilters();
        updateAnalytics();
    }
    
    // Open WhatsApp
    function openWhatsApp(phone) {
        const cleanPhone = phone.replace(/\D/g, '');
        const message = encodeURIComponent('Здравствуйте! Это Любовь Лукащук. Вы оставили заявку на программу "Денежный Водопад". Когда вам удобно провести бесплатную консультацию?');
        window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
    }
    
    // Drag & Drop
    let draggedElement = null;
    
    function handleDragStart(e) {
        draggedElement = e.target;
        e.target.style.opacity = '0.5';
    }
    
    function handleDragEnd(e) {
        e.target.style.opacity = '';
    }
    
    // Setup drop zones
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.stage').forEach(stage => {
            stage.addEventListener('dragover', e => {
                e.preventDefault();
                stage.style.backgroundColor = '#f0f0f0';
            });
            
            stage.addEventListener('dragleave', e => {
                stage.style.backgroundColor = '';
            });
            
            stage.addEventListener('drop', e => {
                e.preventDefault();
                stage.style.backgroundColor = '';
                
                if (draggedElement) {
                    const leadId = parseInt(draggedElement.dataset.leadId);
                    const lead = leads.find(l => l.id === leadId);
                    const newStage = stage.dataset.stage;
                    
                    if (lead && lead.stage !== newStage) {
                        lead.stage = newStage;
                        
                        if (newStage === 'consultation') {
                            trackConsultation(lead);
                        } else if (newStage === 'paid') {
                            if (!lead.amount) {
                                const amount = prompt('Сумма оплаты (EUR):', '2000');
                                lead.amount = parseInt(amount) || 2000;
                            }
                            trackPurchase(lead, lead.amount);
                        }
                        
                        saveLeads();
                        applyFilters();
                        updateAnalytics();
                    }
                }
            });
        });
    });
    
    // Modal functions
    function showAddModal() {
        document.getElementById('addModal').classList.add('active');
    }
    
    function closeModal() {
        document.getElementById('addModal').classList.remove('active');
        document.getElementById('leadForm').reset();
    }
    
    // Form submit
    document.getElementById('leadForm').addEventListener('submit', e => {
        e.preventDefault();
        
        const newLead = {
            id: Date.now(),
            name: document.getElementById('leadName').value,
            email: document.getElementById('leadEmail').value,
            phone: document.getElementById('leadPhone').value,
            age: parseInt(document.getElementById('leadAge').value) || null,
            source: document.getElementById('leadSource').value,
            utm: document.getElementById('leadUTM').value,
            amount: parseInt(document.getElementById('leadAmount').value) || 0,
            note: document.getElementById('leadNote').value,
            stage: 'contacted',
            date: new Date().toISOString().split('T')[0],
            hot: false
        };
        
        leads.push(newLead);
        trackWhatsAppContact(newLead);
        
        saveLeads();
        applyFilters();
        updateAnalytics();
        closeModal();
    });
    
    // Edit lead function
    function editLead(leadId) {
        const lead = leads.find(l => l.id === leadId);
        if (!lead) return;
        
        // Fill form with existing data
        document.getElementById('leadName').value = lead.name;
        document.getElementById('leadEmail').value = lead.email || '';
        document.getElementById('leadPhone').value = lead.phone;
        document.getElementById('leadAge').value = lead.age || '';
        document.getElementById('leadSource').value = lead.source;
        document.getElementById('leadUTM').value = lead.utm || '';
        document.getElementById('leadAmount').value = lead.amount || '';
        document.getElementById('leadNote').value = lead.note || '';
        
        // Show modal
        document.getElementById('addModal').classList.add('active');
        
        // Update form handler for edit mode
        const form = document.getElementById('leadForm');
        form.onsubmit = function(e) {
            e.preventDefault();
            
            // Update existing lead
            lead.name = document.getElementById('leadName').value;
            lead.email = document.getElementById('leadEmail').value;
            lead.phone = document.getElementById('leadPhone').value;
            lead.age = parseInt(document.getElementById('leadAge').value) || null;
            lead.source = document.getElementById('leadSource').value;
            lead.utm = document.getElementById('leadUTM').value;
            lead.amount = parseInt(document.getElementById('leadAmount').value) || 0;
            lead.note = document.getElementById('leadNote').value;
            
            saveLeads();
            applyFilters();
            updateAnalytics();
            closeModal();
            
            // Reset to add mode
            form.onsubmit = null;
        };
    }
    
    // Export data
    function exportData() {
        const csv = [
            ['Имя', 'Телефон', 'Источник', 'UTM', 'Стадия', 'Сумма', 'Дата', 'Заметка'],
            ...filteredLeads.map(l => [
                l.name,
                l.phone,
                l.source,
                l.utm || '',
                l.stage,
                l.amount || 0,
                l.date,
                l.note || ''
            ])
        ].map(row => row.join(',')).join('\n');
        
        // Add BOM for Excel UTF-8
        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `leads_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }
    
    // Tab switching
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName + '-tab').classList.add('active');
        document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    }
    
    // Make function global
    window.showTab = showTab;
    
    </script>
    
    <!-- Supabase CRM Integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-crm-fixed.js"></script>
</body>
</html>

<!-- Quiz Tab Content -->
<div id="quiz-tab" class="tab-content">
    <div class="quiz-section">
        <div class="quiz-header">
            <h3>📊 Результаты квиза "Денежные блоки"</h3>
            <div class="quiz-actions">
                <button onclick="exportQuizDataFromTab()" class="export-btn">📄 Экспорт CSV</button>
                <button onclick="refreshQuizDataFromTab()" class="refresh-btn">🔄 Обновить</button>
            </div>
        </div>
        
        <div class="quiz-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalQuizLeadsTab">0</div>
                <div class="stat-label">Всего прошли</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayQuizLeadsTab">0</div>
                <div class="stat-label">Сегодня</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="weekQuizLeadsTab">0</div>
                <div class="stat-label">За неделю</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="topBlockTab">-</div>
                <div class="stat-label">Топ блок</div>
            </div>
        </div>
        
        <div class="quiz-table-container">
            <table class="quiz-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Имя</th>
                        <th>Телефон</th>
                        <th>Email</th>
                        <th>Основной блок</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="quizTableBodyTab">
                    <tr><td colspan="6" style="text-align: center; padding: 40px;">Загрузка данных...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Quiz tab functions
const blockNames = {
    scarcity: 'Блок Дефицита', guilt: 'Блок Вины', fear: 'Блок Страха',
    unworthiness: 'Блок Недостойности', sacrifice: 'Блок Жертвенности',
    control: 'Блок Контроля', shame: 'Блок Стыда'
};

async function loadQuizDataFromTab() {
    if (!window.supabase) return;
    
    const { createClient } = supabase;
    const client = createClient(
        'https://rntranckosfsnaakjrqh.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJudHJhbmNrb3Nmc25hYWtqcnFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTUyNTIsImV4cCI6MjA3Mzg3MTI1Mn0.Nme48al5xSVPlD4l40z6ZPwTkSL0uC3JQ300IZu7WBA'
    );
    
    try {
        const { data, error } = await client
            .from('quiz_leads')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Quiz data error:', error);
            return;
        }
        
        displayQuizDataInTab(data || []);
    } catch (error) {
        console.error('Quiz load error:', error);
    }
}

function displayQuizDataInTab(leads) {
    const tbody = document.getElementById('quizTableBodyTab');
    tbody.innerHTML = '';
    
    if (!leads.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Нет данных</td></tr>';
        return;
    }
    
    leads.forEach(lead => {
        const date = new Date(lead.created_at).toLocaleString('ru-RU');
        const mainBlock = lead.main_block || 'unknown';
        
        tbody.innerHTML += `
            <tr>
                <td>${date}</td>
                <td><strong>${lead.name}</strong></td>
                <td>${lead.phone}</td>
                <td>${lead.email || '-'}</td>
                <td><span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; color: white; background: #667eea;">${blockNames[mainBlock] || 'Неизвестно'}</span></td>
                <td>
                    <button onclick="contactWhatsAppFromTab('${lead.phone}', '${lead.name}')" style="background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;">💬 WhatsApp</button>
                </td>
            </tr>
        `;
    });
    
    // Update stats
    document.getElementById('totalQuizLeadsTab').textContent = leads.length;
}

function contactWhatsAppFromTab(phone, name) {
    const message = `Здравствуйте, ${name}! Вы прошли тест на денежные блоки. Хочу предложить бесплатную консультацию.`;
    window.open(`https://wa.me/34654420334?text=${encodeURIComponent(message)}`, '_blank');
}

function exportQuizDataFromTab() {
    alert('Экспорт в разработке');
}

function refreshQuizDataFromTab() {
    loadQuizDataFromTab();
}

// Load data when tab is shown
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(tabName + '-tab').classList.add('active');
    document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    
    if (tabName === 'quiz') {
        setTimeout(loadQuizDataFromTab, 100);
    }
}
</script>

            </div>
        </div>
    </div>